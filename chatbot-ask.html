<script type="text/javascript">
  RED.nodes.registerType('chatbot-ask', {
    category: 'ChatBot',
    color: '#a6bbcf',
    defaults: {
      name: {
        value: ''
      },
      answers: {
        value: []
      }
    },
    inputs: 1,
    outputs: 2,
    paletteLabel: 'Ask',
    icon: 'chatbot-ask.png',
    label: function() {
      return this.name || 'Ask';
    },
    oneditsave: function() {
      var answers = $("#node-input-answers-container").editableList('items');

      console.log('answers', answers);
      var node = this;
      node.answers = [];

      var idx;
      for(idx = 0; idx < answers.length; idx++) {
        console.log('--', answers[idx]);
        node.answers.push(answers[idx].find('input').val());
      }


      console.log('fatto', this.answers);
    },


    oneditprepare: function() {

      function resizeRule(rule) {

      }

      $('#node-input-answers-container').css('min-height','300px').css('min-width','450px').editableList({
        addItem: function(container, i, answer) {

          console.log('aggiungo', answer);
          //var answer = opt;
          /*
          if (rule.t === "change" && rule.re) {
            rule.fromt = 're';
            delete rule.re;
          }
          if (rule.t === "set" && !rule.tot) {
            if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
              rule.to = rule.to.substring(4);
              rule.tot = "msg";
            } else {
              rule.tot = "str";
            }
          }
          if (rule.t === "move" && !rule.tot) {
            rule.tot = "msg";
          }
          */

          var value = typeof answer == 'object' ? '' : answer;
          var row1 = $('<div/>').appendTo(container);
          //var row2 = $('<div/>', {style:"margin-top:8px;"}).appendTo(container);
          //var row3 = $('<div/>',{style:"margin-top:8px;"}).appendTo(container);
          //var row4 = $('<div/>',{style:"margin-top:8px;"}).appendTo(container);
          var inputField = $('<input type="text" value="' + value + '"/>', {
            class: 'node-input-rule-type',
            style: 'width:100%px; margin-right:10px;'
            })
            .appendTo(row1);


          /*var selectOptions = [{v:"set",l:set},{v:"change",l:change},{v:"delete",l:del},{v:"move",l:move}];
          for (var i=0;i<4;i++) {
            selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
          }
          var propertyName = $('<input/>',{style:"width:250px",class:"node-input-rule-property-name",type:"text"})
            .appendTo(row1)
            .typedInput({types:['msg','flow','global']});
          $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
            .text(to)
            .appendTo(row2);
          var propertyValue = $('<input/>',{style:"width:250px",class:"node-input-rule-property-value",type:"text"})
            .appendTo(row2)
            .typedInput({default:'str',types:['msg','flow','global','str','num','bool','json','date']});
          var row3_1 = $('<div/>').appendTo(row3);
          $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
            .text(search)
            .appendTo(row3_1);
          var fromValue = $('<input/>',{style:"width:250px",class:"node-input-rule-property-search-value",type:"text"})
            .appendTo(row3_1)
            .typedInput({default:'str',types:['msg','flow','global','str','re','num','bool']});
          var row3_2 = $('<div/>',{style:"margin-top:8px;"}).appendTo(row3);
          $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
            .text(replace)
            .appendTo(row3_2);
          var toValue = $('<input/>',{style:"width:250px",class:"node-input-rule-property-replace-value",type:"text"})
            .appendTo(row3_2)
            .typedInput({default:'str',types:['msg','flow','global','str','num','bool','json']});
          $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
            .text(to)
            .appendTo(row4);
          var moveValue = $('<input/>',{style:"width:250px",class:"node-input-rule-property-move-value",type:"text"})
            .appendTo(row4)
            .typedInput({default:'msg',types:['msg','flow','global']});
          selectField.change(function() {
            var width = $("#node-input-rule-container").width();
            var type = $(this).val();
            if (type == "set") {
              row2.show();
              row3.hide();
              row4.hide();
            } else if (type == "change") {
              row2.hide();
              row3.show();
              row4.hide();
            } else if (type == "delete") {
              row2.hide();
              row3.hide();
              row4.hide();
            } else if (type == "move") {
              row2.hide();
              row3.hide();
              row4.show();
            }
            resizeRule(container);
          });
          selectField.find("option").filter(function() {return $(this).val() == rule.t;}).attr('selected',true);
          propertyName.typedInput('value',rule.p);
          propertyName.typedInput('type',rule.pt);
          propertyValue.typedInput('value',rule.to);
          propertyValue.typedInput('type',rule.tot);
          moveValue.typedInput('value',rule.to);
          moveValue.typedInput('type',rule.tot);
          fromValue.typedInput('value',rule.from);
          fromValue.typedInput('type',rule.fromt);
          toValue.typedInput('value',rule.to);
          toValue.typedInput('type',rule.tot);
          selectField.change();
          */
          var newWidth = $("#node-input-answers-container").width();
          resizeRule(container);
        },
        resizeItem: resizeRule,
        removable: true,
        sortable: true
      });


      var answers = this.answers;
      var idx;
      console.log('rimetto1', this);
console.log('rimetto', answers);
      for (idx = 0; idx < answers.length; idx++) {
        var answer = answers[idx];
        $("#node-input-answers-container").editableList('addItem', answer);
      }




    }
  });
</script>

<script type="text/x-red" data-template-name="chatbot-ask">
  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row" style="margin-bottom:0;">
    <label><i class="fa fa-list"></i> <span>Answers</span></label>
  </div>
  <div class="form-row node-input-rule-container-row">
    <ol id="node-input-answers-container"></ol>
  </div>
</script>

<script type="text/x-red" data-help-name="chatbot-ask">
    <p>ask for alternatives</p>
</script>


